name: Test Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bash wget tar make ninja-build

      - name: Get changed scripts
        id: changed_files
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep "^BLFS_bmo_os_utils/scripts/.*\.sh" || true)
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null | grep "^BLFS_bmo_os_utils/scripts/.*\.sh" || true)
            if [[ -z "$CHANGED" ]]; then
              CHANGED=$(git diff --name-only HEAD~1 HEAD | grep "^BLFS_bmo_os_utils/scripts/.*\.sh" || true)
            fi
          fi
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed scripts: $CHANGED"

      - name: Stop if no scripts changed
        if: steps.changed_files.outputs.changed == ''
        run: |
          echo "‚úî No scripts changed. Skipping build."
          exit 0

      - name: Run changed build scripts safely
        run: |
          set -e
          FAILED_SCRIPTS=""
          
          for script in ${{ steps.changed_files.outputs.changed }}; do
            if [[ -f "$script" && "$script" == BLFS_bmo_os_utils/scripts/* ]]; then
              echo "üöÄ Running: $script"
              chmod +x "$script"
              if timeout 30m bash "$script"; then
                echo "‚úÖ $script completed successfully"
              else
                echo "‚ùå $script failed"
                FAILED_SCRIPTS="$FAILED_SCRIPTS $script"
              fi
            else
              echo "‚ö†Ô∏è  Skipping invalid script: $script"
            fi
          done
          
          if [[ -n "$FAILED_SCRIPTS" ]]; then
            echo "The following scripts failed: $FAILED_SCRIPTS"
            exit 1
          fi
