name: Test Build

on:
  push:
  pull_request:
    branches: [ "main" ]
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # <-- Fix: fetch full history so git diff works

      - name: Set up build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bash wget tar
          sudo apt install -y make

      # ğŸ” Detect which .sh files were changed
      - name: Get changed scripts
        id: changed_files
        run: |
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^BLFS_bmo_os_utils/scripts/.*\.sh" || true)
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # â›” If no scripts changed, stop the workflow
      - name: Stop if no scripts changed
        if: steps.changed_files.outputs.changed == ''
        run: |
          echo "âœ” No scripts changed. Skipping build."
          exit 0

      # ğŸƒ Run only the changed scripts
      - name: Run changed build scripts
        run: |
          for script in ${{ steps.changed_files.outputs.changed }}; do
            echo "ğŸš€ Running: $script"
            chmod +x "$script"
            bash "$script"
          done
